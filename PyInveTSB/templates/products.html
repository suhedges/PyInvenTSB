{% extends "base.html" %}
{% block content %}

<div class="container">

  <!-- Page header -->
  <div class="page-head">
    <div>
      <h2 class="page-title">{{ warehouse }} ¬∑ Product Inventory</h2>
      <p class="muted small">Search, filter, and manage items. Fast keyboard-friendly workflow.</p>
    </div>
    <div class="row">
      <button class="btn" onclick="openAddProduct()">
        <i class="ti ti-plus"></i> Add Product
      </button>
      <a class="btn ghost" href="{{ url_for('warehouse_home', name=warehouse) }}">Back</a>
    </div>
  </div>

  <!-- Sticky toolbar -->
  <div class="toolbar sticky wrap">
    <div class="input-wrap with-icon">
      <span class="input-icon ti ti-search"></span>
      <input id="search" class="input" placeholder="Search internal / customer / bin‚Ä¶" aria-label="Search products">
    </div>

    <select id="stock" class="input" aria-label="Stock filter">
      <option value="">All Stock Levels</option>
      <option value="under_min">Under Minimum</option>
      <option value="optimal">Optimal Range</option>
      <option value="over_max">Over Maximum</option>
    </select>

    <select id="sort" class="input" aria-label="Sort products">
      <option value="">No Sort</option>
      <option value="internal_name">Sort by Internal Name</option>
      <option value="customer_name">Sort by Customer Name</option>
      <option value="bin">Sort by Bin Location</option>
    </select>

    <div class="spacer"></div>
  </div>

  <!-- Cards grid (populated by your JS) -->
  <div id="cards" class="grid inv-cards"></div>

  <!-- Optional empty state -->
  <div id="emptyResults" class="empty-state" style="display:none">
    <div class="empty-icon">üîé</div>
    <h3>No products match your filters</h3>
    <p class="muted">Try adjusting your search or clearing filters.</p>
  </div>
</div>

<!-- Floating scanner buttons -->
<button class="fab" title="Scan barcode" onclick="openScannerModal()">
  <i class="ti ti-barcode"></i>
</button>
<button class="fab right" title="Mass barcode assign" onclick="openMassBarcode()">
  <i class="ti ti-cpu"></i>
</button>

<!-- Product Details Modal (mobile: bottom sheet) -->
<div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="m-title">
  <div class="modal-backdrop" onclick="closeModal()" aria-hidden="true"></div>
  <div class="modal-inner sheet">
    <div class="modal-header sheet-header">
      <div class="grabber" aria-hidden="true"></div>
      <div class="title-wrap">
        <h3 id="m-title" class="modal-title">Product</h3>
      </div>
      <button class="icon close-x" type="button" onclick="closeModal()" aria-label="Close">‚úï</button>
    </div>

    <div class="modal-body sheet-body">
      <div class="details-layout">
        <!-- LEFT: Form -->
        <section class="panel">
          <header class="panel-head">
            <div class="panel-title">Details</div>
            <div class="panel-actions">
            </div>
          </header>
          <form class="stack" id="form-edit"></form>

          <!-- Inline scanner (kept same ID for your JS) -->
          <div id="inline-scan" class="scanbox hidden">
            <div class="scan-controls row wrap">
              <label class="chip selectish">Symbology
                <select id="inlineSymbology">
                  <option value="code128" selected>Code 128</option>
                  <option value="upcean">UPC / EAN</option>
                  <option value="auto">Auto</option>
                </select>
              </label>
              <label class="chip selectish">Engine
                <select id="inlineEngine">
                  <option value="native">Native</option>
                  <option value="zxing" selected>ZXing</option>
                  <option value="quagga">Quagga</option>
                  <option value="auto">Auto</option>
                </select>
              </label>
              <button class="chip" onclick="toggleTorch(event)" id="inlineTorchBtn">
                <i class="ti ti-bulb"></i> Flash
              </button>
              <label class="chip rangeish">Zoom
                <input id="inlineZoom" type="range" min="1" max="1" value="1" step="0.1">
              </label>
              <button class="chip" onclick="snapshotDecode(event, '#inline-view')">
                <i class="ti ti-camera"></i> Snapshot
              </button>
            </div>

            <div class="scan-surface scan-aspect">
              <div id="inline-view" class="scan-video"></div>
              <div class="reticle"></div>
              <div class="scan-hint">Tip: If focus hunts, try Snapshot for full-res decoding.</div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Quick Info (collapses on mobile) -->
        <aside class="panel side">
          <header class="panel-head">
            <div class="panel-title">Quick Actions</div>
          </header>
          <div class="stack">
            <button class="btn ghost" onclick="startInlineScanner(event)">
              <i class="ti ti-barcode"></i> Scan Barcode
            </button>
            <button class="btn danger" onclick="deleteProduct(event)">
              <i class="ti ti-trash"></i> Delete Product
            </button>
            <p class="hint">All changes are saved locally until you press <b>Save</b>.</p>
          </div>
        </aside>
      </div>
    </div>

    <!-- Sticky action bar -->
    <div class="modal-footer sheet-footer">
      <div class="row" style="width:100%">
        <button class="btn ghost" type="button" onclick="closeModal()">Cancel</button>
        <div class="spacer"></div>
        <button class="btn primary btn-lg" onclick="saveProduct(event)">
          <span class="btn-label">Save</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Modal (immersive camera) -->
<div id="scanModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="scanTitle">
  <div class="modal-backdrop" onclick="stopScanner(true)" aria-hidden="true"></div>
  <div class="modal-inner fullscreen">
    <div class="modal-header translucent">
      <button class="chip ghost" onclick="stopScanner(true)" aria-label="Close">
        ‚Üê Close
      </button>
      <h3 id="scanTitle" class="modal-title">Scan a Barcode</h3>
      <div class="spacer"></div>
    </div>

    <div class="modal-body no-pad">
      <div class="scan-surface scan-aspect fill">
        <!-- Camera stream lands in here via your JS -->
        <div id="scanner" class="scan-video"></div>

        <!-- Overlay controls -->
        <div class="scan-overlay top">
          <div class="chip-group wrap">
            <label class="chip selectish">Symbology
              <select id="symbology">
                <option value="code128" selected>Code 128</option>
                <option value="upcean">UPC / EAN</option>
                <option value="auto">Auto</option>
              </select>
            </label>
            <label class="chip selectish">Engine
              <select id="engine">
                <option value="native">Native</option>
                <option value="zxing" selected>ZXing</option>
                <option value="quagga">Quagga</option>
                <option value="auto">Auto</option>
              </select>
            </label>
            <button class="chip" onclick="toggleTorch(event)" id="torchBtn">
              <i class="ti ti-bulb"></i> Flash
            </button>
            <label class="chip rangeish">Zoom
              <input id="zoomRange" type="range" min="1" max="1" value="1" step="0.1">
            </label>
            <button class="chip" onclick="snapshotDecode(event, '#scanner')">
              <i class="ti ti-camera"></i> Snapshot
            </button>
          </div>
        </div>

        <div class="reticle large"></div>

        <div class="scan-overlay bottom">
          <div class="row wrap" style="width:100%">
            <input id="manualCode" class="input flex1" placeholder="Enter barcode manually">
            <button class="btn" onclick="manualLookup()">Lookup</button>
          </div>
          <p class="hint center">If the live view struggles, try Snapshot or switch Engine to ZXing.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mass Barcode Modal -->
<div id="massModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="massTitle">
  <div class="modal-backdrop" onclick="stopMass(true)" aria-hidden="true"></div>
  <div class="modal-inner fullscreen">
    <div class="modal-header translucent">
      <button class="chip ghost" onclick="stopMass(true)" aria-label="Close">
        ‚Üê Close
      </button>
      <h3 id="massTitle" class="modal-title">Mass Barcode Assign</h3>
      <div class="spacer"></div>
    </div>

    <div class="modal-body no-pad">
      <div class="scan-surface scan-aspect fill">
        <div class="scan-overlay top">
          <div class="chip-group wrap">
            <label class="chip selectish">Symbology
              <select id="massSymbology">
                <option value="code128" selected>Code 128</option>
                <option value="upcean">UPC / EAN</option>
                <option value="auto">Auto</option>
              </select>
            </label>
            <label class="chip selectish">Engine
              <select id="massEngine">
                <option value="native">Native</option>
                <option value="zxing" selected>ZXing</option>
                <option value="quagga">Quagga</option>
                <option value="auto">Auto</option>
              </select>
            </label>
            <button class="chip" onclick="toggleTorch(event)" id="massTorchBtn">
              <i class="ti ti-bulb"></i> Flash
            </button>
            <label class="chip rangeish">Zoom
              <input id="massZoom" type="range" min="1" max="1" value="1" step="0.1">
            </label>
            <button class="chip" onclick="snapshotDecode(event, '#massView')">
              <i class="ti ti-camera"></i> Snapshot
            </button>
          </div>
        </div>

        <div class="scan-surface-body">
          <div class="mass-head glass">
            <div id="massName">‚Äî</div>
            <div id="massBin" class="muted">‚Äî</div>
          </div>

          <div class="scan-surface scan-aspect">
            <div id="massView" class="scan-video"></div>
            <div class="reticle"></div>
          </div>

          <div class="scan-overlay bottom">
            <div class="row wrap" style="width:100%">
              <input id="massManual" class="input flex1" placeholder="Type barcode">
              <button class="btn" onclick="massManualAssign()">Assign</button>
            </div>
          </div>
        </div>
      </div>

      <p class="hint center">Point at a product and scan; or type a code and Assign.</p>
    </div>
  </div>
</div>

<script>
  window.INVENT_WAREHOUSE = {{ warehouse|tojson }};
</script>
{% endblock %}
