<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>InventSB</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
</head>
<body>
  <header class="topbar">
    <div class="brand" onclick="window.location.href='{{ url_for('warehouses') }}'">InventSB</div>
    <div class="spacer"></div>
    {% if session.get('user') %}
      <div class="user">ðŸ‘¤ {{ session['user'] }}</div>
      <a class="btn ghost" href="{{ url_for('logout') }}">Logout</a>
    {% endif %}
  </header>

  {% with msgs = get_flashed_messages(with_categories=True) %}
    {% if msgs %}
      <div class="flashwrap">
        {% for cat, m in msgs %}
        <div class="flash {{cat}}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <!-- Robust loader: axios -> quagga -> zxing -> app.js -->
  <script>
    (function(){
      function add(src, cb){
        var s=document.createElement('script'); s.src=src; s.defer=true;
        s.onload=cb; s.onerror=cb; document.head.appendChild(s);
      }
      function needAxios(){ return (typeof window.axios === 'undefined'); }
      function needQuagga(){ return (typeof window.Quagga === 'undefined'); }
      function needZXing(){ return (typeof window.ZXing === 'undefined' || !window.ZXing.BrowserMultiFormatReader); }

      function loadAxios(next){
        if (!needAxios()) return next();
        add("https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js", function(){
          if (!needAxios()) return next();
          add("https://unpkg.com/axios@1.6.8/dist/axios.min.js", function(){
            if (!needAxios()) return next();
            add("{{ url_for('static', filename='vendor/axios.min.js') }}", next);
          });
        });
      }
      function loadQuagga(next){
        if (!needQuagga()) return next();
        add("https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js", function(){
          if (!needQuagga()) return next();
          add("https://unpkg.com/quagga@0.12.1/dist/quagga.min.js", function(){
            if (!needQuagga()) return next();
            add("{{ url_for('static', filename='vendor/quagga.min.js') }}", next);
          });
        });
      }
      function loadZXing(next){
        if (!needZXing()) return next();
        add("https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js", function(){
          if (!needZXing()) return next();
          add("https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js", function(){
            if (!needZXing()) return next();
            add("{{ url_for('static', filename='vendor/zxing.min.js') }}", next);
          });
        });
      }

      loadAxios(function(){
        loadQuagga(function(){
          loadZXing(function(){
            add("{{ url_for('static', filename='app.js') }}", function(){});
          });
        });
      });
    })();
  </script>
</body>
</html>
