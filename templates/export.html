{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <h2 class="page-title">{{ warehouse }} 路 Export Data</h2>
    <p class="muted small">Download inventory snapshots for this warehouse in your preferred format.</p>
  </div>
  <div class="row">
    <a class="btn ghost" href="{{ url_for('warehouse_home', name=warehouse) }}">
      <i class="ti ti-arrow-left"></i> Back
    </a>
  </div>
</div>

<!-- Export controls -->
<div class="toolbar sticky wrap" style="margin-bottom:14px">
  <div class="row wrap">
    <label class="row" style="gap:8px">
      <span class="muted small" style="min-width:72px">Format</span>
      <select id="fmt" class="input" aria-label="Export format">
        <option value="csv" selected>CSV</option>
        <option value="xlsx">Excel (.xlsx)</option>
      </select>
    </label>

    <label class="row" style="gap:8px">
      <span class="muted small">Open in</span>
      <select id="targetMode" class="input" aria-label="Open downloads in">
        <option value="same">Same tab</option>
        <option value="new">New tab</option>
      </select>
    </label>
  </div>

  <div class="spacer"></div>

  <div class="row wrap">
    <span class="hint">Tip: CSV works best for bulk imports and spreadsheets. Choose Excel for a native workbook.</span>
  </div>
</div>

<!-- Export cards -->
<div class="grid two export-grid">
  <a class="wh-card hover export-link" data-basehref="{{ url_for('export_all', name=warehouse) }}">
    <div class="wh-head">
      <div class="wh-titles">
        <div class="wh-name"><i class="ti ti-database-export"></i> All Products</div>
        <div class="wh-meta">Export the complete product inventory</div>
      </div>
      <div class="wh-pin"><i class="ti ti-download"></i></div>
    </div>
  </a>

  <a class="wh-card hover export-link" data-basehref="{{ url_for('export_under_min', name=warehouse) }}">
    <div class="wh-head">
      <div class="wh-titles">
        <div class="wh-name"><i class="ti ti-trending-down"></i> Under Minimum Stock</div>
        <div class="wh-meta">Products that need to be reordered</div>
      </div>
      <div class="wh-pin"><i class="ti ti-download"></i></div>
    </div>
  </a>

  <a class="wh-card hover export-link" data-basehref="{{ url_for('export_over_max', name=warehouse) }}">
    <div class="wh-head">
      <div class="wh-titles">
        <div class="wh-name"><i class="ti ti-trending-up"></i> Over Maximum Stock</div>
        <div class="wh-meta">Products with excess inventory</div>
      </div>
      <div class="wh-pin"><i class="ti ti-download"></i></div>
    </div>
  </a>

  <a class="wh-card hover export-link" data-basehref="{{ url_for('export_optimal', name=warehouse) }}">
    <div class="wh-head">
      <div class="wh-titles">
        <div class="wh-name"><i class="ti ti-check"></i> Optimal Stock</div>
        <div class="wh-meta">Items within the ideal quantity range</div>
      </div>
      <div class="wh-pin"><i class="ti ti-download"></i></div>
    </div>
  </a>
</div>

<!-- Quick actions -->
<div class="row wrap" style="margin-top:12px;gap:8px">
  <button class="btn" id="copyAllLinks"><i class="ti ti-link"></i> Copy export links</button>
  <span class="hint">Keyboard: <b>1</b> All 路 <b>2</b> Under Min 路 <b>3</b> Over Max 路 <b>4</b> Optimal</span>
</div>

<script>
(function(){
  const fmtSel = document.getElementById('fmt');
  const targetSel = document.getElementById('targetMode');
  const links = Array.from(document.querySelectorAll('.export-link'));
  const w = {{ warehouse|tojson }};

  function buildHref(base){
    const url = new URL(base, window.location.origin);
    // keep existing params, just set fmt
    const fmt = (fmtSel && fmtSel.value) || 'csv';
    url.searchParams.set('fmt', fmt);
    return url.pathname + (url.search ? url.search : '');
  }

  function applyLinks(){
    links.forEach(a=>{
      const base = a.getAttribute('data-basehref');
      if (!base) return;
      a.setAttribute('href', buildHref(base));
      const tgt = (targetSel && targetSel.value) || 'same';
      if (tgt === 'new'){
        a.setAttribute('target','_blank');
        a.setAttribute('rel','noopener');
      } else {
        a.removeAttribute('target');
        a.removeAttribute('rel');
      }
    });
  }

  fmtSel && fmtSel.addEventListener('change', applyLinks);
  targetSel && targetSel.addEventListener('change', applyLinks);
  applyLinks();

  // Keyboard shortcuts
  const keyMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
  document.addEventListener('keydown', (e)=>{
    if (!keyMap.hasOwnProperty(e.key)) return;
    const idx = keyMap[e.key];
    const a = links[idx];
    if (a){
      // respect target mode
      const tgt = (targetSel && targetSel.value) || 'same';
      if (tgt === 'new'){ window.open(a.href, '_blank', 'noopener'); }
      else { window.location.href = a.href; }
    }
  });

  // Copy all export links (with current format + target)
  const copyBtn = document.getElementById('copyAllLinks');
  copyBtn && copyBtn.addEventListener('click', async ()=>{
    try{
      const urls = links.map(a => new URL(a.getAttribute('href'), window.location.origin).toString());
      await navigator.clipboard.writeText(urls.join('\n'));
      const orig = copyBtn.innerHTML;
      copyBtn.innerHTML = '<i class="ti ti-check"></i> Copied';
      setTimeout(()=>copyBtn.innerHTML = orig, 1200);
    }catch(e){
      alert('Copy failed.');
    }
  });
})();
</script>

{% endblock %}
