{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <h2 class="page-title">{{ warehouse }} Â· Import Products</h2>
    <p class="muted small">Upload a CSV to add or update products for this warehouse.</p>
  </div>
  <div class="row">
    <a class="btn ghost" href="{{ url_for('warehouse_home', name=warehouse) }}"><i class="ti ti-arrow-left"></i> Back</a>
  </div>
</div>

<div class="split">

  <!-- LEFT: Upload card -->
  <div class="card import">
    <form method="post" enctype="multipart/form-data" class="center" id="importForm" autocomplete="off">
      <div class="drop" id="dropZone" style="transition:background .15s ease,border-color .15s ease">
        <div style="font-size:42px;opacity:.9"><i class="ti ti-file-spreadsheet"></i></div>
        <div>Drag & drop your CSV</div>
        <div class="muted">or</div>
        <label class="btn">
          Browse File
          <input type="file" name="csvfile" accept=".csv" hidden required>
        </label>
        <div class="muted small">Only .csv files are supported</div>
      </div>

      <div id="fileName" class="muted small" style="margin-top:10px;display:none"></div>

      <button class="btn primary" style="margin-top:12px">
        <i class="ti ti-file-import"></i> Import
      </button>
    </form>
  </div>

  <!-- RIGHT: Help / Template -->
  <div class="card">
    <h3 style="margin-top:0">Template & Format</h3>
    <p class="hint" style="margin-bottom:8px">
      <b>Required</b>: <code>Internal Product Name</code>, <code>Customer Product Name</code>
    </p>
    <p class="hint" style="margin-top:0">
      <b>Optional</b>: <code>Internal Product Code</code>, <code>Customer Product Code</code>,
      <code>Bin</code>, <code>Qty</code>, <code>Min</code>, <code>Max</code>, <code>Barcode</code>
    </p>

    <div class="row wrap" style="gap:10px;margin:10px 0 6px">
      <a id="tplLink" class="btn"><i class="ti ti-download"></i> Import Template</a>
      <button type="button" id="copyHeadersBtn" class="btn ghost"><i class="ti ti-clipboard"></i> Copy Headers</button>
    </div>

    <pre class="small" style="margin:10px 0 0;background:#0e1121;border:1px solid var(--border);border-radius:12px;padding:10px;white-space:pre-wrap;overflow:auto;">
Internal Product Name,Customer Product Name,Internal Product Code,Customer Product Code,Bin,Qty,Min,Max,Barcode
Widget A,Customer Widget A,IA-001,CA-001,A-12,10,5,20,123456789012
    </pre>

    <p class="hint" style="margin-top:10px">
      Tip: For large files, keep columns minimal and avoid extra commas in names.
    </p>
  </div>

</div>

<script>
(function(){
  // Build a downloadable CSV template on the fly (no backend route needed)
  const required = ["Internal Product Name","Customer Product Name"];
  const optional = ["Internal Product Code","Customer Product Code","Bin","Qty","Min","Max","Barcode"];
  const allHeaders = required.concat(optional);
  const tplCsv = allHeaders.join(",") + "\n";

  const link = document.getElementById('tplLink');
  if (link){
    const blob = new Blob([tplCsv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    link.href = url;
    link.download = (({{ warehouse|tojson }}||"Warehouse") + "-import-template.csv");
  }

  const copyBtn = document.getElementById('copyHeadersBtn');
  if (copyBtn){
    copyBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(tplCsv.trim());
        const orig = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="ti ti-check"></i> Copied';
        setTimeout(()=>copyBtn.innerHTML = orig, 1200);
      }catch(e){
        alert("Copy failed. You can select and copy the header row from the sample.");
      }
    });
  }

  // Drag & Drop UX
  const dz = document.getElementById('dropZone');
  const input = document.querySelector('input[type="file"][name="csvfile"]');
  const nameEl = document.getElementById('fileName');

  function setFileList(files){
    if (!files || !files.length) return;
    const file = files[0];
    if (!/\.csv$/i.test(file.name)){ alert("Please select a .csv file."); return; }
    // Show name
    if (nameEl){ nameEl.style.display=''; nameEl.textContent = "Selected: " + file.name; }
    // Set input files programmatically
    if (input){
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
    }
  }

  if (dz){
    ['dragenter','dragover'].forEach(evt=>{
      dz.addEventListener(evt, (e)=>{
        e.preventDefault();
        dz.style.background = "#0f1430";
        dz.style.borderColor = "rgba(78,140,255,.6)";
      });
    });
    ['dragleave','drop'].forEach(evt=>{
      dz.addEventListener(evt, (e)=>{
        e.preventDefault();
        dz.style.background = "";
        dz.style.borderColor = "";
      });
    });
    dz.addEventListener('drop', (e)=> setFileList(e.dataTransfer.files));
  }

  if (input){
    input.addEventListener('change', ()=> setFileList(input.files));
  }
})();
</script>

{% endblock %}
